---
title: "Analyzing the Role of Community and Individual Factors in LAMP Grant Funding: Identifying Diverse Barriers Across Clustered US Counties"
subtitle: "FAS Food Systems Impact Fellowship Capstone Project, 2024"
author: "Elliot Hohn\nSr. Agricultural Data Scientist Impact Fellow"
execute:
  echo: false
  warning: false
format: pdf
fig-align: center
editor: visual
---

```{r environment setup}
#| include: false

library(tidyverse)
library(sf)
library(openxlsx)
library(corrplot)
library(NbClust)
library(broom)
library(caret)
library(tidycensus)
library(tidyUSDA)
library(FactoMineR)
library(factoextra)
library(leaflet)
library(units)
library(lmtest)
library(AER)
library(ggthemes)
library(shiny)
library(rmarkdown)
library(plotly)
library(reshape2)
library(bivariatechoropleths)
library(biscale)
library(rio)
library(janitor)
library(paletteer)
library(scales)
library(ggpubr)
library(ggcorrplot)
library(glue)
library(ggsci)
library(parameters)
library(rstatix)
library(DT)
library(extrafont)
library(ggdist)
library(lubridate)
library(gt)
library(gridExtra)
library(patchwork)


census_api_key(Sys.getenv("CENSUS_API_KEY"))
ag_census_api_key <- Sys.getenv("AG_CENSUS_API_KEY")

# reusable function for normalizing data
normalize <- function(x){
  round((x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE)), 4)
}

options(
  scipen = 999,
  dplyr.summarise.inform=FALSE
  )

my_crs <- 5070

my_map <- leaflet(options = leafletOptions(minZoom = 3)) %>%
  #addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setMaxBounds(
    lng1 = -127.8,
    lat1 = 52.5,
    lng2 = -63.8,
    lat2 = 21.4)

subsetter <- function(topic) {
  d <- comm_wealth_all %>%
    filter(topic_area == topic) %>%
    select(fips, year, variable_name, value) %>%
    group_by(fips, variable_name) %>%
    summarise(value = mean(value, na.rm = TRUE)) %>%
    ungroup() %>%
    pivot_wider(names_from = variable_name, values_from = value)

  cols <- colnames(select_if(d, is.numeric))
  d <- d %>%
    mutate(
      across(all_of(cols), normalize))

  d$mean <- rowMeans(d[,cols], na.rm = TRUE)
  d$percentile <- ntile(d$mean, 100)
  
  d <- counties %>%
    merge(d, by = 'fips', all = TRUE) %>%
    st_transform(4326) %>%
    st_set_geometry('geometry') %>%
    select(-mean)

  return(d)
}

pca_prep <- function(d){
  rownames(d) <- d$GEOID
  d <- d %>%
    st_drop_geometry() %>%
    drop_na() %>%
    select(-c(GEOID, county_name, percentile))
  return(d)
}

# pca_reduce <- function(d){
#   pca_results <- PCA(pca_prep(d), graph = FALSE)
#   eig_keepers <- data.frame(pca_results$eig) %>%
#     filter(eigenvalue >= 1.0)
#   comps <- nrow(eig_keepers)
#   if (comps > 0) {
#     scores <- pca_results$var$coord %>% as_tibble()
#     df_reduced <- scores[,1:comps]
#     colnames(df_reduced) <- paste(deparse(substitute(d)), colnames(df_reduced), sep = "_")
#     return(data.frame(df_reduced))
#   } else {
#     return(NULL)
#   }
# }

# font_import()
# loadfonts(device = "all", quiet = TRUE)

#theme_set(theme_void(base_family = "Roboto"))

theme_update(
  axis.text.x = element_text(color = "black", face = "bold", size = 14, 
                             margin = margin(t = 6)),
  axis.text.y = element_text(color = "black", size = 14, hjust = 1, 
                             margin = margin(r = 6)),
  axis.line.x = element_line(color = "black", linewidth = 1),
  panel.grid.major.y = element_line(color = "grey90", size = .6),
  plot.background = element_rect(fill = "white", color = "white"),
  plot.margin = margin(rep(20, 4))
)


## theme for horizontal charts
theme_flip <-
  theme(
    #axis.text.x = element_text(face = "plain", family = "Roboto Mono", size = 14),
    #axis.text.y = element_text(face = "bold", family = "Roboto", size = 14),
    panel.grid.major.x = element_line(color = "grey90", linewidth = .6),
    panel.grid.major.y = element_blank(),
    legend.position = "top", 
    legend.text = element_text(
      #family = "Roboto Mono", 
      size = 18),
    legend.title = element_text(face = "bold", size = 18, margin = margin(b = 25))
  )
```

## Introduction

### Local Agriculture Market Program (LAMP)

The USDA's Agricultural Marketing Service (AMS) administers a variety of grant programs aimed at strengthening local and regional food systems. The Local Agriculture Market Program (LAMP) is one such program that supports direct producer-to-consumer marketing, food enterprises, and value-added agricultural products. Established under the 2018 Farm Bill, LAMP fosters community collaboration and public-private partnerships to improve regional food economies, aiding in the development of business strategies and infrastructure for local food systems. The Farm Bill provided LAMP \$50 million per year in mandatory funding and the programs received significant supplemental funding through the Consolidated Appropriations Act of 2021 and the American Rescue Plan of 2021.[^1] The major grant programs within LAMP include the [Local Food Promotion Program (LFPP)](https://www.ams.usda.gov/services/grants/lfpp), [Regional Food Systems Partnership (RFSP)](https://www.ams.usda.gov/services/grants/rfsp), and the [Farmers Market Promotion Program (FMPP)](https://www.ams.usda.gov/services/grants/fmpp).

[^1]: <https://www.ams.usda.gov/sites/default/files/media/LAMP_Report_to_Congress.pdf>

![Promotional materials for LAMP. Image: USDA-AMS, 2024](img/LAMP_Twitter.png){fig-align="center"}

### Building community capital through food systems investment

#### Allocating grant funding

The goals of the LAMP program include: (1) simplify the application processes and the reporting processes for the Program; (2) improve income and economic opportunities for producers and food businesses through job creation; and (3) strengthen capacity and regional food system development through community collaboration and expansion of mid-tier value chains.[^2]

[^2]: <https://www.ams.usda.gov/services/grants/lamp>. Accessed April 20, 2024

Each program within LAMP includes a set of constraints intended to improve the allocation of resources to specific program activity areas.

In 2021, AMS partnered with Florida A&M University and the University of Maryland Eastern Shore on a project focusing on the following goals[^3]:

[^3]: <https://www.ams.usda.gov/sites/default/files/media/MSDUSDAAMSGrantApplicantTASociallyDisadvantaged.pdf>

1.  Evaluate barriers to AMS grant opportunities for socially disadvantaged communities

2.  Invest in building trust and confidence between these communities and the USDA

3.  Take action to rectify inequalities in program access through targeted outreach, training, and technical assistance.

The results of this work are intended to be used to improve access and reduce barriers for all applicants, presumably part of the agency's renewed efforts to address USDA’s history of systemic discrimination.[^4]

[^4]: Kashyap, Pratyoosh, Becca B.R. Jablonski, and Allison Bauman. “Exploring the Relationships among Stocks of Community Wealth, State Farm to School Policies, and the Intensity of Farm to School Activities.” *Food Policy* 122 (January 2024): 102570. <https://doi.org/10.1016/j.foodpol.2023.102570>.

#### Community preparedness

Recent research suggests that the success of food system interventions, policies, and strategies for local economic development may hinge on the preexisting levels of community capital.[^5]

[^5]: Schmit, Todd M., Becca B.R. Jablonski, Alessandro Bonanno, and Thomas G. Johnson. “Measuring Stocks of Community Wealth and Their Association with Food Systems Efforts in Rural and Urban Places.” *Food Policy* 102 (July 2021): 102119. <https://doi.org/10.1016/j.foodpol.2021.102119>.

Additional research showed positive associations between cultural and social capital and farm to school activity.[^6]

[^6]: Kashyap, Pratyoosh, Becca B.R. Jablonski, and Allison Bauman. “Exploring the Relationships among Stocks of Community Wealth, State Farm to School Policies, and the Intensity of Farm to School Activities.” *Food Policy* 122 (January 2024): 102570. <https://doi.org/10.1016/j.foodpol.2023.102570>.

Much of this research highlights community assets that are often overlooked in community development work.[^7]

[^7]: Kashyap, Pratyoosh, Becca B.R. Jablonski, and Allison Bauman. “Exploring the Relationships among Stocks of Community Wealth, State Farm to School Policies, and the Intensity of Farm to School Activities.” *Food Policy* 122 (January 2024): 102570. <https://doi.org/10.1016/j.foodpol.2023.102570>.

## Objective

This report intends to lay the groundwork for an analytic approach that helps determine which community characteristics are associated with LAMP grant funding allocation. This could help determine if there is something akin to a "threshold of community preparedness" the unknowingly results in certain low-resource communities being excluded from LAMP programming. If so, the results of this research could provide insight into the particular characteristics associated with LAMP access, which could help agency staff to better allocate resources to ensure equitable access to grant funds.

## Methods

### Data access and aggregation

As a first step, a variety of data sets were obtained, cleaned, organized, and used for general data exploration. Information on specific datasets and sources can be found below. All work was done using the open source statistical software R version 4.4.0.[^8]

[^8]: <https://www.r-project.org/>

#### LAMP grant data

```{r load lamp and join data}
#| output: false

# Data downloaded directly from URL on the LAMP Navigator webpage
lamp_url <- 'https://www.ams.usda.gov/sites/default/files/media/LAMPDatasetandDataDictionary.xlsx'
lamp <- read.xlsx(lamp_url, sheet = 'LAMP Dataset 2006 to 2023') %>%
  rename(
    state = State,
    city = City.2
    ) %>%
  mutate(city = str_squish(str_trim(tolower(city)))) %>%
  filter(!state %in% c('HI', 'AK', 'PR'))

# Load US Cities dataset from github
url <- 'https://raw.githubusercontent.com/kelvins/US-Cities-Database/main/csv/us_cities.csv'
city_loc <- read.csv(url) %>%
  select(-c(ID, COUNTY)) %>%
  rename(
    city = CITY,
    state = STATE_CODE
  ) %>%
  mutate(city = str_squish(str_trim(tolower(city)))) %>%
  group_by(city, state) %>%
  filter(row_number()==1) %>% 
  ungroup()

# do the join
lamp <- merge(lamp, city_loc, by = c('city', 'state'), all.x = TRUE)

# convert to sf object
lamp_sf <- lamp %>% 
  drop_na(LATITUDE, LONGITUDE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  st_transform(4326)

# Load counties data (downloaded somewhere on the interwebs...)
counties <- st_read('data/cb_2021_us_county_20m/cb_2021_us_county_20m.shp') %>%
  filter(!STATE_NAME %in% c('Alaska', 'Hawaii', 'Puerto Rico')) %>%
  rename(
    county_name = NAMELSAD,
    fips = GEOID
    ) %>%
  select(fips, county_name, geometry) %>%
  #st_set_crs(4326) %>%
  st_transform(4326)

# spatial join points within counties
lamp_by_county <- counties %>%
  st_join(lamp_sf, join = st_contains, left = TRUE) %>%
  group_by(fips) %>%
  mutate(total_grant = sum(Award.Amount)) %>%
  mutate(lamp_funded = as.factor(ifelse(is.na(Award.Amount) | Award.Amount == 0, 0, 1))) %>%
  #rename(County = NAMELSAD) %>%
  select(fips, county_name, lamp_funded, Award.Amount)
```

Information on LAMP awards came from the LAMP Navigator website, where AMS has made this information publicly available, along with a dashboard for sorting, filtering, and visualizing the grant information.[^9] Along with information about the organizations receiving the grant, the dataset includes information on the purpose of the grant (e.g., technical assistance, infrastructure, processing), the match amount, and the total project cost.

[^9]: <https://www.ams.usda.gov/data/lamp-navigator>

##### LAMP grant award amounts, 2006 - 2023

###### Each green dash represents a single grant award

```{r lamp grant distribution}
#| fig-height: 6
#| fig-width: 12
#| fig-align: center
#| out-width: 100%

l <- lamp %>%
  mutate(
    Year = ymd(Year, truncated = 2L)
  )

g <- ggplot(l, aes(x = Year, y = Award.Amount)) +
  geom_point(shape = 95, size = 10, alpha = .4, color = '#005440') +
  theme(legend.position="none") +
  scale_x_date(date_breaks = '1 year', date_labels = "'%y") + 
  scale_y_continuous(labels = dollar) +
  annotate(
    geom = 'text',
    x = as.Date('2011-01-01'),
    y = 400000,
    label = 'No 2013 awards\ndue to lapse\nof funding',
    size = 4,
    color = 'grey35'
  ) +
  annotate(
    geom = "curve",
    x = as.Date('2011-10-01'),
    xend = as.Date('2013-01-01'),
    y = 350000, yend = 20000,
    curvature = -0.3,
    arrow = arrow(),
    color = 'grey35'
  )

g
```

##### Geographic distribution of LAMP Grants, 2006-2023

```{r lamp funded leaflet map}

cols <- c('1' = "#014745", '0' = "grey")

ggplot(lamp_by_county) +
  geom_sf(
    aes(fill = factor(lamp_funded)),
    color = 'transparent') +
  scale_fill_manual(
    values = cols,
    labels = c('Did not receive\nLAMP funding', 'Received\nLAMP funding')
    ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.title=element_blank(),
    plot.title = element_text(hjust = 0.5)
  ) +
  ggtitle("Counties that recieved LAMP grants, 2006 to 2023")
```

#### Community characteristics

A variety of socioeconomic and environmental factors were investigated to assess how they may influence the likelihood of receiving a LAMP grant. These factors include indicators of community wealth, which encompasses social capital, natural capital, financial capital, and a variety of other forms of wealth, which have been shown impacts the ability to engage and participate in such programs.[^10] Additionally, it includes factors related to poverty and food security, which have been shown to exacerbate vulnerabilities and influence accessibility and participation in programs.[^11] Finally, considering the food systems-focus of LAMP, factors related to urbanization and proximity to agricultural land were included because they can influence market dynamics and food system connectivity.[^12]

[^10]: Flora, Cornelia Butler, Jan L. Flora, and Stephen P. Gasteyer. *Rural Communities: Legacy and Change*. 4th ed. Routledge, 2018. <https://doi.org/10.4324/9780429494697>.

[^11]: Alisha Coleman-Jensen, Matthew P. Rabbitt, Christian A. Gregory, and Anita Singh. 2021. Household Food Security in the United States in 2020, ERR-298, U.S. Department of Agriculture, Economic Research Service.

[^12]: Pothukuchi, Kameshwari, and Jerome L. Kaufman. “The Food System: A Stranger to the Planning Field.” *Journal of the American Planning Association* 66, no. 2 (June 30, 2000): 113–24. <https://doi.org/10.1080/01944360008976093>.

##### Indicators of community wealth

```{r prep comm wealth data}

## Community Wealth
comm_wealth_url <- 'https://raw.githubusercontent.com/CSU-Local-and-Regional-Food-Systems/USDA-AMS-Data-and-Metrics/main/Indicators%20of%20Community%20Wealth/community_wealth.csv'
comm_wealth_all <- read.csv(comm_wealth_url) %>%
  filter(fips > 100) %>%
  filter(!county_name %in% c('Menominee County', 'Kidder County'))# remove national level rows 

# Function to add leading 0 to 4-digit fips values in comm_wealth to facilitate later joins
add_leading_zero <- function(x) {
  # Check if the number has 4 digits
  ifelse(nchar(x) == 4, paste0("0", x), x)
}

# apply funcion to fips column
comm_wealth_all$fips <- sapply(comm_wealth_all$fips, add_leading_zero)

comm_wealth_all <- comm_wealth_all %>%
  filter(variable_name != 'broad_11')
```

Community wealth data were accessed via the USDA AMS Data and Metrics GitHub repository.[^13] The main source of data was the "Indicators of Community Wealth" dataset within this repository, which was the result of various pre-processing steps that are outlined within the Rmarkdown file included in the repo.

[^13]: <https://github.com/CSU-Local-and-Regional-Food-Systems/USDA-AMS-Data-and-Metrics/tree/main>

```{}
```
